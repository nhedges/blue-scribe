<!DOCTYPE html>
<html>
    <head>
        <script>
            function gen_plan_preview(plan) {
                var html = "";
                html = html + "<tr><td><img src=\"plan/" + plan.id + "/preview.png\" alt=\"Plan " + plan.id + "\" style=\"width:256px;\"></td>\n";
                html = html + "<td>";
                html = html + "<p>" + plan.name + "</p>";
                html = html + "<p>" + plan.desc + "</p>";
                html = html + gen_burn_button(plan);
                html = html + "</td></tr>";
                return html;
            }
            function gen_burn_button(plan) {
                var html = "<form action=\"/burner/start\" method=\"post\" enctype=\"multipart/form-data\">";
                html = html + "<input type=\"hidden\" id=\"planId\" name=\"planId\" value=\"" + plan.id + "\">";
                html = html + "<input type=\"range\" id=\"powerScale\" name=\"powerScale\" step=\"0.01\" min=\"0.0\" max=\"2.0\">";
                html = html + "<input type=\"submit\" value=\"Start Burn\">";
                html = html + "</form>";
                return html;
            }
            function load_plans() {
                var apiUrl = 'plan?all';
                fetch(apiUrl, {headers: {'Accept': 'application/json'}}).then(response => {
                return response.json();
            }).then(data => {
                console.log(data.length.toString());
                var newContent = "<table>";
                for (var i = 0; i < data.length; i++) {
                    var a = data[i];
                    console.log(a.name);
                    newContent = newContent + gen_plan_preview(data[i]);
                }
                newContent = newContent + "</table>";
                console.log(newContent);
                document.getElementById("plan-list").innerHTML
                = newContent;
            }).catch(err => {
                // Do something for an error here
            });
            }
            function gen_pause_unpause_button(paused) {
                var result = "";
                var buttonTxt = "";
                if (paused) {
                    buttonTxt = "Unpause";
                }
                else
                {
                    buttonTxt = "Pause";
                }
                result = result + "<form action=\"/burner/status\" method=\"post\" enctype=\"multipart/form-data\" onsubmit=\"setTimeout(function () { window.location.reload(); }, 10)\">";
                result = result + "<input type=\"hidden\" name=\"paused\" value=\"" + !paused + "\">";
                result = result + "<input type=\"submit\" value=\"" + buttonTxt + "\">";
                result = result + "</form>";
                return result;
            }
            function load_status() {
                console.log("loading status...");
                var statusReport = "";
                var apiUrl = 'burner/status';
                fetch(apiUrl, {headers: {'Accept': 'application/json'}}).then(response => {
                return response.json();
            }).then(data => {
                var newContent = "<table>";
                newContent = newContent + "<tr><td>Paused:</td><td>" + data.paused.toString() + "</td></tr>";
                newContent = newContent + "</table>";
                newContent = newContent + gen_pause_unpause_button(data.paused);
                console.log(newContent);
                document.getElementById("status-report").innerHTML
                = document.getElementById("status-report").innerHTML + newContent;
            }).catch(err => {
                console.log("error: " + err);
                // Do something for an error here
            });
            }
            function on_load() {
                load_status();
                load_plans();
            }
        </script>
    </head>
    <body onload="on_load()">
        <h1>Laser Engraver Home</h1>
        <h2>Status</h2>
        <p id="status-report">
            <form action="/burner/status" method="post" enctype="multipart/form-data">
                <input type="hidden" name="home" value="true">
                <input type="submit" value="Re-align">
            </form>
        </p>
        <h2>Plans</h2>
        <p id="plan-list">
            Loading plan list...
        </p>
        <form action="/plan/new" method="post" enctype="multipart/form-data" onsubmit="setTimeout(function () { window.location.reload(); }, 10)">
            <fieldset>
                <legend>New Plan</legend>
                <label for="name">Plan name:</label><br>
                <input type="text" id="new-plan-name" name="name" value="John"><br>
                <input type="file" name="image" accept=".png"><br>
                <label for="desc">Plan Description:</label><br>
                <textarea cols="40", rows="10", name="desc"></textarea><br>
                <input type="submit" value="Create">
            </fieldset>
        </form>
    </body>
</html>
