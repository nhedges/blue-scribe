<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="default.css">
        <script>
            function gen_plan_preview(plan) {
                var html = "";
                html = html + "<tr><td><img src=\"plan/" + plan.id + "/preview.png\" alt=\"Plan " + plan.id + "\" style=\"width:256px;\"></td>\n";
                html = html + "<td>";
                html = html + "<p>" + plan.name + "</p>";
                html = html + "<p>" + plan.desc + "</p>";
                html = html + "<p>(" + plan.width + " x " + plan.height + ")</p>";
                html = html + gen_burn_button(plan);
                html = html + gen_corner_align_button(plan.id);
                html = html + gen_delete_button(plan.id);
                html = html + "</td></tr>";
                return html;
            }
            function gen_burn_button(plan) {
                var html = "<form action=\"/burner/start\" method=\"post\" enctype=\"multipart/form-data\">";
                html = html + "<input type=\"hidden\" id=\"planId\" name=\"planId\" value=\"" + plan.id + "\">";
                html = html + "<input type=\"range\" id=\"powerScale\" name=\"powerScale\" step=\"0.01\" min=\"0.0\" max=\"2.0\">";
                html = html + "<input type=\"submit\" id=\"burn-button\" value=\"Start Burn\">";
                html = html + "</form>";
                return html;
            }
            function gen_delete_button(plan) {
                var html =
                    "<form id=\"delete-" + plan + "\" method=\"post\" onsubmit=\"return delete_button_press(" + plan + ");\"><input type=\"submit\" value=\"Delete\"></form>";
                return html;
            }
            function gen_corner_align_button(plan) {
                var html = "<form action=\"/burner/start\" method=\"post\" enctype=\"multipart/form-data\">";
                html = html + "<input type=\"hidden\" id=\"cornerPlanId\" name=\"planId\" value=\"" + plan + "\">";
                html = html + "<input type=\"hidden\" id=\"cornerPowerScale\" name=\"powerScale\" value=\"corner-align\">";
                html = html + "<input type=\"submit\" id=\"corner-align-button\" value=\"Corner Alignment\">";
                html = html + "</form>";
                return html;
            }
            function load_plans(path) {
                var apiUrl = 'plan?' + path;
                fetch(apiUrl, {headers: {'Accept': 'application/json'}}).then(response => {
                return response.json();
            }).then(data => {
                console.log(data.length.toString());
                var newContent = "<table>";
                for (var i = 0; i < data.length; i++) {
                    var a = data[i];
                    console.log(a.name);
                    newContent = newContent + gen_plan_preview(data[i]);
                }
                newContent = newContent + "</table>";
                newContent = newContent +
                    "<form id=\"load-all-button\" method=\"post\" onsubmit=\"return load_all_button_press();\"><input type=\"submit\" value=\"Load All\"></form>";
                console.log(newContent);
                document.getElementById("plan-list").innerHTML
                = newContent;
            }).catch(err => {
                // Do something for an error here
            });
            }
            function delete_button_press(id) {
                var submit = confirm('Delete plan? (Cannot be undone)');
                if (submit)
                {
                    var apiUrl = 'plan?planId=' + id;
                    setTimeout(function() {fetch(apiUrl, {method: 'DELETE'});}, 10);
                    setTimeout(function() {load_plans('some');}, 20);
                }
                return false;
            }
            function delete_plan(id){
                var apiUrl = 'plan?' + id;
                fetch(apiUrl, {method: 'DELETE'});
                return false;
            }
            function reload_pause_button(){
                var container = document.getElementById("pause-unpause-form");
                var content = container.innerHTML;
                container.innerHTML= content;

               //this line is to watch the result in console , you can remove it later
                console.log("Refreshed");
            }
            function gen_pause_unpause_button(paused) {
                var result = "";
                var buttonTxt = "";
                if (paused) {
                    buttonTxt = "Unpause";
                }
                else
                {
                    buttonTxt = "Pause";
                }
                result = result + "<form id=\"pause-unpause-form\" action=\"/burner/status\" method=\"post\" enctype=\"multipart/form-data\" onsubmit=\"setTimeout(function(){load_status();}, 200);\">";
                result = result + "<input type=\"hidden\" name=\"paused\" value=\"" + !paused + "\">";
                result = result + "<input type=\"submit\" value=\"" + buttonTxt + "\">";
                result = result + "</form>";
                return result;
            }
            function load_status() {
                console.log("loading status...");
                var statusReport = "";
                var apiUrl = 'burner/status';
                fetch(apiUrl, {headers: {'Accept': 'application/json'}, cache: "no-store"}).then(response => {
                return response.json();
            }).then(data => {
                var newContent = "<table>";
                newContent = newContent + "<tr><td>Paused:</td><td>" + data.paused.toString() + "</td></tr>";
                newContent = newContent + "</table>";
                newContent = newContent + gen_pause_unpause_button(data.paused);
                console.log(newContent);
                document.getElementById("status-report").innerHTML
                = newContent;
            }).catch(err => {
                console.log("error: " + err);
                // Do something for an error here
            });
            }
            function on_load() {
                load_status();
                load_plans('some');
            }
            function cancel_button_press() {
                var submit = confirm('Cancel burn? (Cannot be undone)');
                if (submit)
                {
                    setTimeout(function() {load_status();}, 10);
                }
                return submit;
            }
            function create_button_press() {
                return setTimeout(function() {load_plans('some');}, 10);
            }
            function load_all_button_press() {
                setTimeout(function() {load_plans('all');}, 10);
                return false;
            }
        </script>
    </head>
    <body onload="on_load()">
        <h1>Laser Engraver Home</h1>
        <h2>Status</h2>
        <p>
            <div id="status-report"></div>
            <form action="/burner/status" method="post" enctype="multipart/form-data">
                <input type="hidden" name="home" value="true">
                <input type="submit" id="home-button" value="Re-align">
            </form>
            <form action="/burner/status" method="post" enctype="multipart/form-data" onsubmit="return cancel_button_press();">
                <input type="hidden" name="cancel" value="true">
                <input type="submit" id="cancel-button" value="Cancel">
            </form>
        </p>
        <h2>Plans</h2>
        <p id="plan-list">
            Loading plan list...
        </p>
        <form action="/plan/new" method="post" enctype="multipart/form-data" onsubmit="return create_button_press();">
            <fieldset>
                <legend>New Plan</legend>
                <label for="name">Plan name:</label><br>
                <input type="text" id="new-plan-name" name="name" value="John"><br>
                <input type="file" name="image" accept=".png"><br>
                <label for="desc">Plan Description:</label><br>
                <textarea cols="40", rows="10", name="desc"></textarea><br>
                <input type="submit" id="create-button" value="Create">
            </fieldset>
        </form>
    </body>
</html>
